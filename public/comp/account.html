<main>
    <script type="text/javascript" src="ua-parser.min.js"></script>

    <div id="title-grid" class="title-grid">
        <button onclick="view.change('profile')" id="profile-btn" state="">PROFILE</button>
        <button onclick="view.change('sessions')" id="sessions-btn" state="">SESSIONS</button>
    </div>

    <div id="profile" class="content-box">
        <h2>PROFILE</h2>
        <div id="profile-box" class="box">Username: <span id="pb_username"></span></div>
        
        <div id="profile-cards">
            <div class="card">
                <h3>CHANGE USERNAME</h3>
                <p>With changing your username, the system will delete all your sessions.</p>
                <button class="button arrowed-button" onclick="popup.open('cu')">
                    CHANGE
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </div>
    
            <div class="card">
                <h3>CHANGE PASSWORD</h3>
                <p>With changing your password, the system will delete all your sessions.</p>
                <button class="button arrowed-button" onclick="popup.open('cp')">
                    CHANGE
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </div>
            
    
            <div class="card" id="da-card">
                <h3>DELETE ACCOUNT</h3>
                <p>With deleting your account, you delete all your data stored in the system. After that, it can't be recovered.</p>
                <button class="button arrowed-button" onclick="popup.open('da')">
                    DELETE
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </div>
        </div>
        
        

        
        <div id="outer-box-bg" onclick="popup.close()">
            <div id="outer-box" onclick="event.cancelBubble=true">
                <div id="outer-box-title">
                    <h3 id="ob-title">TITLE-TITLE-H3</h3>
                    <button class="button x-button" onclick="popup.close()" id="close-popup">
                        <svg width="5" height="5" viewBox="0 0 5 5" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect y="4.24261" width="6" height="1" rx="0.5" transform="rotate(-45 0 4.24261)" fill="black"/>
                            <rect x="0.707092" width="6" height="1" rx="0.5" transform="rotate(45 0.707092 0)" fill="black"/>
                        </svg>
                    </button>
                </div>
                <div id="ob-content">
                    <div class="box" id="da">
                        <label for="da_username">USERNAME</label>
                        <input type="text" class="input" id="da_username" state="">
                        <label for="da_password">PASSWORD</label>
                        <input type="password" class="input" id="da_password" state="">
                        <p class="error" id="da-error"></p>
                        <button class="button arrowed-button" onclick="localAccount.deleteAccount()" id="da-btn" state="">
                            DELETE
                            <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                                <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                            </svg>
                        </button>
                    </div>
                    <div class="box" id="cp">
                        <label for="cpc_password">CURRENT PASSWORD</label>
                        <input type="password" class="input" id="cpc_password" state="">
                        <label for="cpn_password">NEW PASSWORD</label>
                        <input type="password" class="input" id="cpn_password" state="">
                        <p class="error" id="cp-error"></p>
                        <button class="button ticked-button" onclick="localAccount.changePassword()" id="cp-btn" state="">
                            SAVE
                            <svg width="81" height="60" viewBox="0 0 81 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M71.8432 3C73.5001 1.34315 76.1863 1.34315 77.8432 3V3C79.5001 4.65685 79.5001 7.34315 77.8432 9L31.3015 55.5417C29.6446 57.1986 26.9583 57.1986 25.3015 55.5418V55.5418C23.6446 53.8849 23.6446 51.1986 25.3015 49.5417L71.8432 3Z" fill="black"/>
                                <path d="M30.8009 50.0381C32.4578 51.6949 32.4578 54.3812 30.8009 56.0381V56.0381C29.144 57.6949 26.4578 57.6949 24.8009 56.0381L3 34.2372C1.34315 32.5803 1.34315 29.894 3 28.2372V28.2372C4.65685 26.5803 7.34315 26.5803 9 28.2372L30.8009 50.0381Z" fill="black"/>
                            </svg>
                        </button>
                    </div>
                    <div class="box" id="cu">
                        <label for="cu_password">PASSWORD</label>
                        <input type="password" class="input" id="cu_password" state="">
                        <label for="cu_username">NEW USERNAME</label>
                        <input type="text" class="input" id="cu_username" state="">
                        <p class="error" id="cu-error"></p>
                        <button class="button ticked-button" onclick="localAccount.changeUsername()" id="cu-btn" state="">
                            SAVE
                            <svg width="81" height="60" viewBox="0 0 81 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M71.8432 3C73.5001 1.34315 76.1863 1.34315 77.8432 3V3C79.5001 4.65685 79.5001 7.34315 77.8432 9L31.3015 55.5417C29.6446 57.1986 26.9583 57.1986 25.3015 55.5418V55.5418C23.6446 53.8849 23.6446 51.1986 25.3015 49.5417L71.8432 3Z" fill="black"/>
                                <path d="M30.8009 50.0381C32.4578 51.6949 32.4578 54.3812 30.8009 56.0381V56.0381C29.144 57.6949 26.4578 57.6949 24.8009 56.0381L3 34.2372C1.34315 32.5803 1.34315 29.894 3 28.2372V28.2372C4.65685 26.5803 7.34315 26.5803 9 28.2372L30.8009 50.0381Z" fill="black"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <div id="sessions" class="content-box">
        <h2>SESSIONS</h2>
        <div id="session-head">
            <div>
                <input type="checkbox" name="" id="checkall-session" oninput="sessions.action()">
                <button class="button arrowed-button" state="disabled" id="delete-selected-sessions" onclick="sessions.delete()">
                    DELETE SELECTED
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </div>
            <p class="error" id="session-error"></p>
        </div>

        <div id="sessions-list"></div>
    </div>

    <div id="sign-in-up">
        <div id="siu-box">
            <div id="siu-title-grid" class="title-grid">
                <button id="sign-in-btn" state="" onclick="view.change('sign-in')">SIGN IN</button>
                <button id="sign-up-btn" state="" onclick="view.change('sign-up')">SIGN UP</button>
            </div>
            <form id="sign-in" class="siu-form">
                <h2>SIGN IN</h2>
                <label for="username_si">USERNAME</label>
                <input type="text" name="username_si" id="username_si" state="" class="input">
                <label for="password_si">PASSWORD</label>
                <input type="password" name="password_si" id="password_si" state="" class="input">
                <div id="rem7">
                    <input type="checkbox" name="remember7_si" id="remember7_si">
                    <label for="remember7_si" id="rem7_si-label">REMEMBER ME</label>
                </div>
                <p id="si-error" class="error"></p>
                <button type="button" selector="siu-btn" onclick="localAccount.signIn()" id="si-btn" state="" class="button arrowed-button">
                    SIGN IN 
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </form>
            <form id="sign-up" class="siu-form">
                <h2>SIGN UP</h2>
                <label for="username_su">USERNAME</label>
                <input type="text" name="username_su" id="username_su" state="" class="input">
                <div id="su-pw-div">
                    <label for="password_su">PASSWORD</label>
                    <input type="password" name="password_su" id="password_su" state="" class="input">
                    <label for="password_again_su">PASSWORD AGAIN</label>
                    <input type="password" name="password_again_su" id="password_again_su" state="" class="input">
                </div>
                <p class="error" id="su-error"></p>
                <button type="button" selector="siu-btn" onclick="localAccount.signUp()" id="su-btn" state="" class="button arrowed-button">
                    SIGN UP
                    <svg width="41" height="70" viewBox="0 0 41 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9C1.34315 7.34315 1.34315 4.65685 3 3V3C4.65685 1.34315 7.34315 1.34314 9 3L38 32C39.6568 33.6568 39.6568 36.3431 38 38V38C36.3431 39.6568 33.6568 39.6568 32 38L3 9Z" fill="black"/>
                        <path d="M32 32C33.6569 30.3431 36.3431 30.3431 38 32V32C39.6569 33.6569 39.6569 36.3431 38 38L9 67C7.34315 68.6569 4.65685 68.6569 3 67V67C1.34315 65.3431 1.34315 62.6569 3 61L32 32Z" fill="black"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</main>

<script id="script">
    const popup = {
        open: function (v) {
            document.querySelector('#outer-box-bg').style.display = 'flex';
            setTimeout(function () {
                document.querySelector('#outer-box-bg').style.opacity = '1';
            }, 001)

            for (let i = 0; i < popup.views.length; i++) {
                if (popup.views[i] == v) {
                    document.querySelector(`#${popup.views[i]}`).style.display = 'flex';
                    document.querySelector('#ob-title').innerText = popup.vNames[i];
                } else {
                    document.querySelector(`#${popup.views[i]}`).style.display = 'none';
                }
            }
        },
        close: function () {
            document.querySelector('#outer-box-bg').style.opacity = '0';
            setTimeout(function () {
                document.querySelector('#outer-box-bg').style.display = 'none';
            }, 150)

            document.querySelector('#da_username').value = '';
            document.querySelector('#da_password').value = '';

            document.querySelector('#cpc_password').value = '';
            document.querySelector('#cpn_password').value = '';

            document.querySelector('#cu_password').value = '';
            document.querySelector('#cu_username').value = '';
        },
        views: ['da', 'cp', 'cu'],
        vNames: ['DELETE ACCOUNT', 'CHANGE PASSWORD', 'CHANGE USERNAME']
    }

    const localAccount = {
        load: function () {
            document.querySelector('#sessions-list').innerHTML = '';
            document.querySelector('#checkall-session').checked = false;
            sessions.deletebtn.disable();

            dom.loadingEP.innerHTML = "";
            loading.loading();
            loading.start();
            fetch(`${domain.server}/account/load`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `${account.getAuth()}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                if (res.eCode == '404xUNF' || res.eCode == '403xIST' || res.eCode == '403xIAT') {
                    localStorage.removeItem('jwt');
                    sessionStorage.removeItem('jwt');
                    localStorage.removeItem('session');
                    sessionStorage.removeItem('session');

                    account.action();
                    view.change('sign-in');
                    document.querySelector('#si-error').innerText = ecodes.lookup(res.eCode);
                }
                localAccount.applyData(res);

                loading.stop();
                dom.render.style.display = 'block';
            })
            .catch(function () {
                loading.error();
                dom.loadingEP.innerHTML = 'Error while trying to load /account/load.<br>Retry in: <span id="cd">60</span>';
                if (cdrunning) {
                    return;
                }
                cdrunning = true;
                const cd = setInterval(function () {
                    if (!document.querySelector('#cd')) {
                        clearInterval(cd);
                        return;
                    }
                    document.querySelector('#cd').innerHTML--;
                    if (document.querySelector('#cd').innerHTML == 0) {
                        clearInterval(cd);
                        cdrunning = false;
                        localAccount.load();
                    }
                }, 1000);
            });
        },
        signIn: function () {
            let smthWrong = false;
            if (document.querySelector('#si-btn').attributes.state.nodeValue != "") {
                return;
            }
            if (!validateString(document.querySelector('#username_si').value)) {
                document.querySelector('#username_si').attributes.state.nodeValue = 'wrong';
                document.querySelector('#si-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#username_si').attributes.state.nodeValue = '';
            }
            if (!validateString(document.querySelector('#password_si').value)) {
                document.querySelector('#password_si').attributes.state.nodeValue = 'wrong';
                document.querySelector('#si-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#password_si').attributes.state.nodeValue = '';
            }
            if (smthWrong) {
                return;
            }
            else {
                document.querySelector('#si-error').innerText = '';
            }
            document.querySelector('#si-btn').attributes.state.nodeValue = "disabled";
            document.querySelector('#si-btn>svg').outerHTML = loading.svg.loading;
            document.querySelector('#si-btn>svg').style.animation = '1s loading infinite linear';

            fetch(`${domain.server}/account/signin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username_si=${document.querySelector('#username_si').value}&password_si=${document.querySelector('#password_si').value}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                switch (res.eCode) {
                    case '404xUNF':
                        document.querySelector('#username_si').attributes.state.nodeValue = 'wrong';
                        break;
                    case '405xWP':
                        document.querySelector('#password_si').attributes.state.nodeValue = 'wrong';
                        break;
                    default:
                        break;
                }
                document.querySelector('#si-error').innerText = ecodes.lookup(res.eCode);

                document.querySelector('#si-btn').attributes.state.nodeValue = "";
                document.querySelector('#si-btn>svg').outerHTML = dom.svg.arrow;
                document.querySelector('#si-btn>svg').style.animation = '';

                if (res.eCode == '200xSSI') {
                    if (document.querySelector('#remember7_si').checked) {
                        localStorage.setItem('jwt', res.jwt);
                        localStorage.setItem('session', res.session);
                    }
                    else {
                        sessionStorage.setItem('jwt', res.jwt);
                        sessionStorage.setItem('session', res.session);
                    }

                    view.init();

                    document.querySelector('#username_si').value = "";
                    document.querySelector('#password_si').value = "";

                    account.action();
                }
            })
            .catch(function () {
                if (document.querySelector('#si-error').innerText == '') {
                    document.querySelector('#si-error').innerText = 'There was an error, while trying to sign in. Please try again later and/or report the bug!';
                    document.querySelector('#si-btn').attributes.state.nodeValue = "";
                    document.querySelector('#si-btn>svg').outerHTML = dom.svg.arrow;
                    document.querySelector('#si-btn>svg').style.animation = '';
                }
            });
        },
        signUp: function () {
            let smthWrong = false;
            if (document.querySelector('#su-btn').attributes.state.nodeValue != "") {
                return;
            }
            if (!validateString(document.querySelector('#username_su').value)) {
                document.querySelector('#username_su').attributes.state.nodeValue = 'wrong';
                document.querySelector('#su-error').style.fontSize = '10pt';
                document.querySelector('#su-error').style.margin = '0px';
                document.querySelector('#su-error').innerText = 'Usernames and passwords can only contain the letters of the English alphabets, numbers, and the common special characters (+, -, /, *, %, =, (, ), [, ], <, >, #, &, @, {, }, !, ?, ., :, ;, _, ,)!';
                if (document.querySelector('#username_su').value == "") {
                    document.querySelector('#su-error').style.fontSize = '12pt';
                    document.querySelector('#su-error').innerText = 'Empty field(s)!';
                }
                smthWrong = true;
            } else {
                document.querySelector('#username_su').attributes.state.nodeValue = '';
            }
            if (!validateString(document.querySelector('#password_su').value)) {
                document.querySelector('#password_su').attributes.state.nodeValue = 'wrong';
                document.querySelector('#su-error').style.fontSize = '10pt';
                document.querySelector('#su-error').style.margin = '0px';
                document.querySelector('#su-error').innerText = 'Usernames and passwords can only contain the letters of the English alphabets, numbers, and the common special characters (+, -, /, *, %, =, (, ), [, ], <, >, #, &, @, {, }, !, ?, ., :, ;, _, ,)!';
                if (document.querySelector('#password_su').value == "") {
                    document.querySelector('#su-error').style.fontSize = '12pt';
                    document.querySelector('#su-error').innerText = 'Empty field(s)!';
                }
                smthWrong = true;
            } else {
                document.querySelector('#password_su').attributes.state.nodeValue = '';
            }

            if (smthWrong) {
                return;
            }
            else {
                document.querySelector('#su-error').innerText = '';
                if (document.querySelector('#password_again_su').value != document.querySelector('#password_su').value) {
                    document.querySelector('#password_su').attributes.state.nodeValue = 'wrong';
                    document.querySelector('#password_again_su').attributes.state.nodeValue = 'wrong';
                    document.querySelector('#su-error').style.fontSize = '12pt';
                    document.querySelector('#su-error').style.margin = 'unset';
                    document.querySelector('#su-error').innerText = 'The 2 given passwords are not the same!';
                    return;
                }
                else {
                    document.querySelector('#password_su').attributes.state.nodeValue = '';
                    document.querySelector('#password_again_su').attributes.state.nodeValue = '';
                }
            }
            document.querySelector('#su-btn').attributes.state.nodeValue = "disabled";
            document.querySelector('#su-btn>svg').outerHTML = loading.svg.loading;
            document.querySelector('#su-btn>svg').style.animation = '1s loading infinite linear';

            fetch(`${domain.server}/account/signup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `username_su=${document.querySelector('#username_su').value}&password_su=${document.querySelector('#password_su').value}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                if (res.eCode == '405xUAU') {
                    document.querySelector('#username_su').attributes.state.nodeValue = 'wrong';
                }

                document.querySelector('#su-error').innerText = ecodes.lookup(res.eCode);

                document.querySelector('#su-btn').attributes.state.nodeValue = "";
                document.querySelector('#su-btn>svg').outerHTML = dom.svg.arrow;
                document.querySelector('#su-btn>svg').style.animation = '';

                if (res.eCode == '200xSSU') {
                    view.change('sign-in');

                    document.querySelector('#username_su').value = "";
                    document.querySelector('#password_su').value = "";
                    document.querySelector('#password_again_su').value = "";
                }
            })
            .catch(function () {
                if (document.querySelector('#su-error').innerText == '') {
                    document.querySelector('#su-error').innerText = 'There was an error, while trying to sign up. Please try again later and/or report the bug!';
                    document.querySelector('#su-btn').attributes.state.nodeValue = "";
                    document.querySelector('#su-btn>svg').outerHTML = dom.svg.arrow;
                    document.querySelector('#su-btn>svg').style.animation = '';
                }
            });
        },
        applyData: function (data) {
            if (!data.user) {
                return;
            }
            if (data.user.username) {
                document.querySelector('#pb_username').innerText = data.user.username;
            }
            if (data.user.sessions) {
                sessions.init(data.user.sessions);
            }
        },
        changeUsername: function () {
            let smthWrong = false;
            if (document.querySelector('#cu-btn').attributes.state.nodeValue != "") {
                return;
            }
            if (!validateString(document.querySelector('#cu_password').value)) {
                document.querySelector('#cu_password').attributes.state.nodeValue = 'wrong';
                document.querySelector('#cu-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#cu_password').attributes.state.nodeValue = '';
            }
            if (!validateString(document.querySelector('#cu_username').value)) {
                document.querySelector('#cu_username').attributes.state.nodeValue = 'wrong';
                document.querySelector('#cu-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#cu_username').attributes.state.nodeValue = '';
            }
            if (smthWrong) {
                return;
            }
            else {
                document.querySelector('#cu-error').innerText = '';
            }
            document.querySelector('#close-popup').style.display = 'none';
            document.querySelector('#cu-btn').attributes.state.nodeValue = "disabled";
            document.querySelector('#cu-btn>svg').outerHTML = loading.svg.loading;
            document.querySelector('#cu-btn>svg').style.animation = '1s loading infinite linear';


            fetch(`${domain.server}/account/changeusername`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `${account.getAuth()}&cu_password=${document.querySelector('#cu_password').value}&cu_username=${document.querySelector('#cu_username').value}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                switch (res.eCode) {
                    case '405xWP':
                        document.querySelector('#cu_password').attributes.state.nodeValue = 'wrong';
                        break;
                    case '405xUAU': 
                        document.querySelector('#cu_username').attributes.state.nodeValue = 'wrong';
                        break;
                    case '200xSUC':
                        url.change('?homepage');
                        account.signOut();
                        return;
                        break; /*:?:*/
                    default:
                        break;
                }
                document.querySelector('#cu-error').innerText = ecodes.lookup(res.eCode);

                document.querySelector('#cu-btn').attributes.state.nodeValue = "";
                document.querySelector('#cu-btn>svg').outerHTML = dom.svg.tick;
                document.querySelector('#cu-btn>svg').style.animation = '';
                document.querySelector('#close-popup').style.display = 'flex';

            })
            .catch(function () {
                if (document.querySelector('#cu-error').innerText == '') {
                    document.querySelector('#cu-error').innerText = 'There was an error, while trying to change username. Please try again later and/or report the bug!';
                    document.querySelector('#cu-btn').attributes.state.nodeValue = "";
                    document.querySelector('#cu-btn>svg').outerHTML = dom.svg.tick;
                    document.querySelector('#cu-btn>svg').style.animation = '';
                    document.querySelector('#close-popup').style.display = 'flex';
                }
            });
        },
        changePassword: function () {
            let smthWrong = false;
            if (document.querySelector('#cp-btn').attributes.state.nodeValue != "") {
                return;
            }
            if (!validateString(document.querySelector('#cpc_password').value)) {
                document.querySelector('#cpc_password').attributes.state.nodeValue = 'wrong';
                document.querySelector('#cp-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#cpc_password').attributes.state.nodeValue = '';
            }
            if (!validateString(document.querySelector('#cpn_password').value)) {
                document.querySelector('#cpn_password').attributes.state.nodeValue = 'wrong';
                document.querySelector('#cp-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#cpn_password').attributes.state.nodeValue = '';
            }
            if (smthWrong) {
                return;
            }
            else {
                document.querySelector('#cp-error').innerText = '';
            }
            document.querySelector('#close-popup').style.display = 'none';
            document.querySelector('#cp-btn').attributes.state.nodeValue = "disabled";
            document.querySelector('#cp-btn>svg').outerHTML = loading.svg.loading;
            document.querySelector('#cp-btn>svg').style.animation = '1s loading infinite linear';


            fetch(`${domain.server}/account/changepassword`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `${account.getAuth()}&cpc_password=${document.querySelector('#cpc_password').value}&cpn_password=${document.querySelector('#cpn_password').value}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                switch (res.eCode) {
                    case '405xWP':
                        document.querySelector('#cpc_password').attributes.state.nodeValue = 'wrong';
                        break;
                    case '200xSPC':
                        url.change('?homepage');
                        account.signOut();
                        return;
                        break; /*:?:*/
                    default:
                        break;
                }
                document.querySelector('#cp-error').innerText = ecodes.lookup(res.eCode);

                document.querySelector('#cp-btn').attributes.state.nodeValue = "";
                document.querySelector('#cp-btn>svg').outerHTML = dom.svg.tick;
                document.querySelector('#cp-btn>svg').style.animation = '';
                document.querySelector('#close-popup').style.display = 'flex';

            })
            .catch(function () {
                if (document.querySelector('#cp-error').innerText == '') {
                    document.querySelector('#cp-error').innerText = 'There was an error, while trying to change password. Please try again later and/or report the bug!';
                    document.querySelector('#cp-btn').attributes.state.nodeValue = "";
                    document.querySelector('#cp-btn>svg').outerHTML = dom.svg.tick;
                    document.querySelector('#cp-btn>svg').style.animation = '';
                    document.querySelector('#close-popup').style.display = 'flex';
                }
            });
        },
        deleteAccount: function () {
            let smthWrong = false;
            if (document.querySelector('#da-btn').attributes.state.nodeValue != "") {
                return;
            }
            if (!validateString(document.querySelector('#da_username').value)) {
                document.querySelector('#da_username').attributes.state.nodeValue = 'wrong';
                document.querySelector('#da-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#da_username').attributes.state.nodeValue = '';
            }
            if (!validateString(document.querySelector('#da_password').value)) {
                document.querySelector('#da_password').attributes.state.nodeValue = 'wrong';
                document.querySelector('#da-error').innerText = 'Invalid character(s) or empty field(s)!';
                smthWrong = true;
            } else {
                document.querySelector('#da_password').attributes.state.nodeValue = '';
            }
            if (smthWrong) {
                return;
            }
            else {
                document.querySelector('#da-error').innerText = '';
            }
            document.querySelector('#close-popup').style.display = 'none';
            document.querySelector('#da-btn').attributes.state.nodeValue = "disabled";
            document.querySelector('#da-btn>svg').outerHTML = loading.svg.loading;
            document.querySelector('#da-btn>svg').style.animation = '1s loading infinite linear';


            fetch(`${domain.server}/account/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `${account.getAuth()}&da_username=${document.querySelector('#da_username').value}&da_password=${document.querySelector('#da_password').value}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                switch (res.eCode) {
                    case '405xWU':
                        document.querySelector('#da_username').attributes.state.nodeValue = 'wrong';
                        break;
                    case '405xWP':
                        document.querySelector('#da_password').attributes.state.nodeValue = 'wrong';
                        break;
                    case '200xSAD':
                        url.change('?homepage');
                        account.signOut();
                        return;
                        break; /*:?:*/
                    default:
                        break;
                }
                document.querySelector('#da-error').innerText = ecodes.lookup(res.eCode);

                document.querySelector('#da-btn').attributes.state.nodeValue = "";
                document.querySelector('#da-btn>svg').outerHTML = dom.svg.arrow;
                document.querySelector('#da-btn>svg').style.animation = '';
                document.querySelector('#close-popup').style.display = 'flex';

            })
            .catch(function () {
                if (document.querySelector('#da-error').innerText == '') {
                    document.querySelector('#da-error').innerText = 'There was an error, while trying to delete account. Please try again later and/or report the bug!';
                    document.querySelector('#da-btn').attributes.state.nodeValue = "";
                    document.querySelector('#da-btn>svg').outerHTML = dom.svg.arrow;
                    document.querySelector('#da-btn>svg').style.animation = '';
                    document.querySelector('#close-popup').style.display = 'flex';
                }
            });
        }
    }

    const view = {
        change: function (v) {
            if (v == "sign-in" || v == "sign-up") {
                document.querySelector('#sign-in-up').style.display = 'flex';
                document.querySelector('#title-grid').style.display = 'none';

                document.querySelector('#si-error').innerText = '';
                document.querySelector('#username_si').attributes.state.nodeValue = '';
                document.querySelector('#username_si').value = '';
                document.querySelector('#password_si').attributes.state.nodeValue = '';
                document.querySelector('#password_si').value = '';
                document.querySelector('#remember7_si').checked = false;

                document.querySelector('#su-error').innerText = '';
                document.querySelector('#username_su').attributes.state.nodeValue = '';
                document.querySelector('#username_su').value = '';
                document.querySelector('#password_su').attributes.state.nodeValue = '';
                document.querySelector('#password_su').value = '';
                document.querySelector('#password_again_su').attributes.state.nodeValue = '';
                document.querySelector('#password_again_su').value = '';
            }
            else {
                document.querySelector('#sign-in-up').style.display = 'none';
                document.querySelector('#title-grid').style.display = 'flex';
            }
            for (let i = 0; i < view.views.length; i++) {
                if (view.views[i] == v) {
                    document.querySelector(`#${view.views[i]}`).style.display = 'flex';
                    document.querySelector(`#${view.views[i]}-btn`).attributes.state.nodeValue = "active";
                } else {
                    document.querySelector(`#${view.views[i]}`).style.display = 'none';
                    document.querySelector(`#${view.views[i]}-btn`).attributes.state.nodeValue = "";
                }
            }
            if (!url.popstate && url.url.search != '?account') {
                url.change(`?account&v=${v}`);
            }
            else {
                url.replace(`?account&v=${v}`);
            }
        },
        init: function () {
            dom.render.style.display = 'none';
            loading.loading();
            loading.start();
            if (localStorage.getItem('jwt') || sessionStorage.getItem('jwt')) {
                if (url.searchParams().get('v') && url.searchParams().get('v') != 'sign-up' && url.searchParams().get('v') != 'sign-in') {
                    view.change(url.searchParams().get('v'));
                }
                else {
                    view.change('profile');
                }
                localAccount.load();
            }
            else {
                if (url.searchParams().get('v') && (url.searchParams().get('v') == 'sign-up' || url.searchParams().get('v') == 'sign-in')) {
                    view.change(url.searchParams().get('v'));
                }
                else {
                    view.change('sign-in');
                }
                loading.stop();
                dom.render.style.display = 'block';
            }
        },
        views: ["sessions", "profile", "sign-in", "sign-up"]
    }

    function validateString(text) {
        const allowedChars = {
            array: ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "+", "-", "/", "*", "%", "=", "(", ")", "[", "]", "<", ">", "#", "&", "@", "{", "}", "!", "?", ".", ":", ";", "_", ","],
            in: function (char) {
                return allowedChars.array.includes(char.toLowerCase());
            }
        }

        if (text == "") {
            return false;
        }

        let a = text.split('');
        let i = 0;
        while (i < a.length && allowedChars.in(a[i])) {
            i++;
        }
        return i == a.length;
    }

    const sessions = {
        init: function (sessions) {
            const sessionsList = document.querySelector('#sessions-list');
            for (let i = 0; i < sessions.length; i++) {
                let session = document.createElement('div');
                session.setAttribute('class', 'session');

                let check4delete = document.createElement('input');
                check4delete.setAttribute('type', 'checkbox');
                check4delete.setAttribute('class', 'check4delete');
                check4delete.setAttribute('oninput', 'sessions.deletebtn.action()');
                check4delete.setAttribute('id', sessions[i]._id);
                session.appendChild(check4delete);

                let session_grid = document.createElement('div');
                let time = new Date(sessions[i].time);
                let expires = new Date(sessions[i].expires);
                let lastActivity = new Date(sessions[i].lastActivity);
                session_grid.innerHTML = 
                `<p class="time">CREATED: <span>${time.toLocaleString()}</span></p>
                 <p class="expires">EXPIRES: <span>${expires.toLocaleString()}</span></p>
                 <p class="last-activity">LAST ACTIVITY: <span>${lastActivity.toLocaleString()} (not working yet bruh)</span></p>
                 <p class="user-agent">USER-AGENT: <span>${sessions[i].UAG}</span></p>
                 <p class="origin">ORIGIN: <span>${sessions[i].origin}</span></p>`;

                session.appendChild(session_grid);
                
                if (sessions[i].token != null) {
                    let current = document.createElement('p');
                    current.setAttribute('class', 'error');
                    current.innerText = 'CURRENT SESSION';
                    session_grid.appendChild(current);
                }

                sessionsList.appendChild(session);
            }
        },
        delete: function () {
            if (document.querySelector('#delete-selected-sessions').attributes.state.nodeValue != "") {
                return;
            }
            let checkboxes = document.querySelectorAll('.check4delete');
            let sumList = [];
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    sumList.push(checkboxes[i].id);
                }
            }
            if (!sumList) {
                return;
            }
            document.querySelector('#session-error').innerHTML = '';
            document.querySelector('#delete-selected-sessions').attributes.state.nodeValue = "disabled";
            document.querySelector('#delete-selected-sessions>svg').outerHTML = loading.svg.loading;
            document.querySelector('#delete-selected-sessions>svg').style.animation = '1s loading infinite linear';
            fetch(`${domain.server}/account/deletesession`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `${account.getAuth()}&sumList=${sumList.toString()}`
            })
            .then(function (res) {
                return res.json();
            })
            .then(function (res) {
                if (res.eCode == '200xSSD') {
                    localAccount.load();
                    document.querySelector('#session-error').innerHTML = '';
                    document.querySelector('#delete-selected-sessions').attributes.state.nodeValue = "";
                    document.querySelector('#delete-selected-sessions>svg').outerHTML = dom.svg.arrow;
                    document.querySelector('#delete-selected-sessions>svg').style.animation = '';
                }
            })
            .catch(function () {
                document.querySelector('#session-error').innerHTML = 'There was an error, while trying to delete sessions. Please try again later and/or report the bug!';
                document.querySelector('#delete-selected-sessions').attributes.state.nodeValue = "";
                document.querySelector('#delete-selected-sessions>svg').outerHTML = dom.svg.arrow;
                document.querySelector('#delete-selected-sessions>svg').style.animation = '';
            });
        },
        action: function () {
            let checkboxes = document.querySelectorAll('.check4delete');
            if (document.querySelector('#checkall-session').checked) {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = true;
                }
                sessions.deletebtn.enable();
            } else {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = false;
                }
                sessions.deletebtn.disable();
            }
        },
        deletebtn: {
            enable: function () {
                document.querySelector('#delete-selected-sessions').attributes.state.nodeValue = "";
            },
            disable: function () {
                document.querySelector('#delete-selected-sessions').attributes.state.nodeValue = "disabled";
            },
            action: function () {
                let checkboxes = document.querySelectorAll('.check4delete');
                let db = 0;
                for (let i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        db++;
                    }
                }

                if (db > 0) {
                    sessions.deletebtn.enable();
                } else {
                    sessions.deletebtn.disable();
                }

                if (db == checkboxes.length) {
                    document.querySelector('#checkall-session').checked = true;
                }
                else {
                    document.querySelector('#checkall-session').checked = false;
                }
            }
        }
    }
</script>
    
<style>
    main {
        height: 100%;
        width: 100%;
    }
    .title-grid {
        display: none;
        overflow-x: auto;
        height: 40px;
    }
    .title-grid button {
        max-width: 200px;
        min-width: 100px;
        width: 100%;
        border: 0px solid transparent;
        background-color: unset;
        border-radius: unset;
        padding: 10px 0px 10px 0px;
        text-align: left;
        font-size: 12pt;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: 0.1s;
    }
    .title-grid button:hover {
        background-color: var(--button-hover-color);
        cursor: pointer;
    }
    .title-grid button[state="active"] {
        border-bottom: 5px var(--accent-color) solid;
        background-color: var(--accent-bg-color);
        padding: 7.5px 0px;
    }
    .content-box {
        position: absolute;
        height: calc(100% - 40px);
        width: 100%;
        top: 40px;
        left: 0px;

        display: none;
        flex-direction: column;
        overflow-y: auto;
        padding: 10px;
        box-sizing: border-box;
    }
    .content-box h2, .content-box h3, .content-box p {
        margin: 5px 0px;
    }
    #siu-title-grid {
        display: flex;
    }
    #sign-in-up {
        height: 100%;
        width: 100%;
        display: none;
        align-items: center;
        justify-content: center;
    }
    #siu-box {
        width: 100%;
        height: 100%;
        max-width: 400px;
        max-height: 400px;
        background-color: var(--bg-color);
        overflow-y: auto;
    }
    .siu-form {
        height: 360px;
        padding: 10px;
        box-sizing: border-box;
        flex-direction: column;
    }
    .siu-form h2 {
        margin: 0px 0px 15px 0px;
    }
    .siu-form input {
        margin: 0px 0px 7.5px 0px;
    }
    .siu-form label {
        padding: 2px 0px;
    }
    .siu-form button[selector="siu-btn"] {
        align-self: flex-end;
        margin-top: auto;
    }
    .siu-form button[selector="siu-btn"][state="disabled"]:hover {
        padding: 10px 10px 10px 15px;
        cursor: default;
    }
    #su-pw-div {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
    }
    #su-pw-div input {
        margin: 0px 0px 3px 0px;
    }
    .error {
        color: red;
    }
    #allowed-chars-p {
        margin: 0px;
        font-size: 10pt;
    }
    #rem7_si-label, #remember7_si:hover {
        cursor: pointer;
    }
    input[type="checkbox"] {
        accent-color: var(--accent-color);
    }
    .box {
        border-left: var(--accent-color) 5px solid;
        padding: 10px;
        box-sizing: border-box;
        background-color: var(--accent-bg-color);
        display: flex;
        flex-direction: column;
        max-width: 400px;
        width: 100%;
    }
    .box button {
        align-self: flex-end;
        margin-top: 10px;
    }
    #profile-box {
        display: flex;
        flex-direction: row;
        gap: 5px;
    }
    #da {
        border-left: 5px red solid;
    }
    #da button {
        background-color: red;
    }
    #da button[state="disabled"] {
        background-color: red !important;
    }
    #da-card {
        border-top: 0px red solid;
    }
    #da-card:hover {
        border-top: 10px red solid;
    }
    #da-card button {
        background-color: red;
    }
    #outer-box-bg {
        height: calc(100% - 3em);
        width: 100%;
        position: fixed;
        top: 3em;
        left: 0;
        background-color: var(--menu-bg-color);
        justify-content: center;
        align-items: center;
        display: none;
        padding: 10px;
        box-sizing: border-box;
        opacity: 0;
        transition: 0.1s all;
        overflow-y: scroll;
    }
    #outer-box-title {
        display: flex;
        padding-left: 10px;
        justify-content: space-between;
        align-items: center;

        background-color: var(--bg-color);
        height: 40px;
    }
    #outer-box-title h3 {
        margin: 0px;
    }
    #ob-content {
        background-color: var(--bg-color);
    }
    #outer-box {
        width: 100%;
        max-width: 400px;
    }
    @media screen and (height < calc(3em + 220px)) {
        #outer-box {
            position: absolute;
            top: 0px;
        }
    }
    @media screen and (width > 750px) and (height > calc(3em + 425px)) {
        #outer-box-bg {
            left: 250px;
            width: calc(100% - 250px);
        }
    }
    @media screen and (width < calc(250px + 400px + 200px))  {
        .box {
            max-width: 550px;
        }
    }
    #profile-cards {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    .card {
        display: flex;
        max-width: 400px;
        /* min-width: 300px; */
        width: auto;
        flex-direction: column;
        min-height: 200px;
        background-color: var(--accent-bg-color);
        padding: 10px;
        box-sizing: border-box;
        transition: 0.1s all;
        border-top: 0px solid var(--accent-color);
    }
    .card:hover {
        border-top: 10px var(--accent-color) solid;
    }
    .card .button {
        margin-top: auto;
        align-self: flex-end;
    }
    .session {
        display: flex;
        align-items: center;
        flex-direction: row;
        gap: 10px;
        background-color: var(--accent-bg-color);
        margin-bottom: 10px;
        padding: 10px;
        overflow-x: auto;
    }
    .session>div {
        display: grid;
        grid-template-areas: 
        'time expires'
        'last-activity last-activity'
        'user-agent user-agent'
        'origin current';
        width: 100%;
        column-gap: 10px;
    }
    .time {
        grid-area: time;
    }
    .user-agent {
        grid-area: user-agent;
    }
    .last-activity {
        grid-area: last-activity;
    }
    .expires {
        grid-area: expires;
    }
    .origin {
        grid-area: origin;
    }
    .session>div>.error {
        grid-area: current;
    }
    @media screen and (width < 910px) and (height > calc(3em + 425px)) {
        .session>div {
            grid-template-areas: 
            'time'
            'expires'
            'last-activity'
            'user-agent'
            'origin'
            'current';
            column-gap: 0px;
        }
    }
    @media screen and (width < 660px) and (height <= calc(3em + 425px)) {
        .session>div {
            grid-template-areas: 
            'time'
            'expires'
            'last-activity'
            'user-agent'
            'origin'
            'current';
            column-gap: 0px;
        }
    }
    #session-head {
        padding: 10px;

    }
    #session-head>div {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
</style>